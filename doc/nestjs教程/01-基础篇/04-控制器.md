# 控制器

在 NestJS 中，控制器负责处理 HTTP 请求，定义路由，并将请求转发给相应的服务。控制器使用装饰器（Decorators）来定义路由和请求方法，使得代码更加简洁和易于维护。

## 1. 控制器的基本概念

控制器是处理客户端请求的核心组件，它接收请求，调用相应的服务处理业务逻辑，然后返回响应。在 NestJS 中，控制器使用 `@Controller` 装饰器来标记，并且可以定义路由前缀。

## 2. 创建控制器

### 2.1 使用 Nest CLI 创建控制器

使用 Nest CLI 可以快速创建一个控制器：

```bash
# 创建一个名为 "users" 的控制器
nest generate controller users

# 或者使用简写
nest g co users
```

运行该命令后，Nest CLI 会在 `src/users` 目录下生成以下文件：

- `users.controller.ts` - 控制器文件
- `users.controller.spec.ts` - 控制器测试文件

### 2.2 手动创建控制器

你也可以手动创建控制器文件。创建一个新的文件 `src/users/users.controller.ts`，并添加以下内容：

```typescript
import { Controller, Get } from '@nestjs/common';

@Controller('users') // 定义路由前缀为 "users"
export class UsersController {
  @Get() // 定义 GET 请求路由
  findAll() {
    return 'This action returns all users';
  }
}
```

## 3. 注册控制器

创建控制器后，需要将其注册到模块中。打开 `src/users/users.module.ts` 文件（如果没有该文件，可以使用 Nest CLI 创建：`nest g mo users`），并将控制器添加到 `controllers` 数组中：

```typescript
import { Module } from '@nestjs/common';
import { UsersController } from './users.controller';

@Module({
  controllers: [UsersController], // 注册控制器
})
export class UsersModule {}
```

然后，将 `UsersModule` 导入到根模块 `AppModule` 中：

```typescript
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { UsersModule } from './users/users.module';

@Module({
  imports: [UsersModule], // 导入 UsersModule
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

## 4. 请求方法装饰器

NestJS 提供了多种请求方法装饰器，用于处理不同类型的 HTTP 请求：

| 装饰器 | HTTP 方法 | 描述 |
|--------|-----------|------|
| `@Get()` | GET | 用于处理 GET 请求 |
| `@Post()` | POST | 用于处理 POST 请求 |
| `@Put()` | PUT | 用于处理 PUT 请求 |
| `@Delete()` | DELETE | 用于处理 DELETE 请求 |
| `@Patch()` | PATCH | 用于处理 PATCH 请求 |
| `@Options()` | OPTIONS | 用于处理 OPTIONS 请求 |
| `@Head()` | HEAD | 用于处理 HEAD 请求 |
| `@All()` | ALL | 用于处理所有类型的 HTTP 请求 |

### 4.1 使用请求方法装饰器

```typescript
import { Controller, Get, Post, Put, Delete } from '@nestjs/common';

@Controller('users')
export class UsersController {
  @Get()
  findAll() {
    return 'This action returns all users';
  }

  @Get(':id')
  findOne() {
    return 'This action returns a user';
  }

  @Post()
  create() {
    return 'This action creates a user';
  }

  @Put(':id')
  update() {
    return 'This action updates a user';
  }

  @Delete(':id')
  remove() {
    return 'This action removes a user';
  }
}
```

## 5. 路由参数

### 5.1 路径参数

路径参数用于获取 URL 中的动态部分，使用 `@Param()` 装饰器来获取。

```typescript
import { Controller, Get, Param } from '@nestjs/common';

@Controller('users')
export class UsersController {
  @Get(':id')
  findOne(@Param('id') id: string) {
    return `This action returns user #${id}`;
  }
}
```

### 5.2 查询参数

查询参数用于获取 URL 中的查询字符串，使用 `@Query()` 装饰器来获取。

```typescript
import { Controller, Get, Query } from '@nestjs/common';

@Controller('users')
export class UsersController {
  @Get()
  findAll(@Query() query: any) {
    return `This action returns all users with query: ${JSON.stringify(query)}`;
  }
}
```

你也可以指定查询参数的名称：

```typescript
@Get()
findAll(@Query('page') page: number, @Query('limit') limit: number) {
  return `This action returns users with page: ${page} and limit: ${limit}`;
}
```

### 5.3 请求体

请求体用于获取 POST、PUT、PATCH 等请求中的数据，使用 `@Body()` 装饰器来获取。

首先，我们需要创建一个 DTO（数据传输对象）来定义请求体的结构：

```typescript
// src/users/dto/create-user.dto.ts
export class CreateUserDto {
  readonly name: string;
  readonly email: string;
  readonly password: string;
}
```

然后，在控制器中使用 `@Body()` 装饰器获取请求体：

```typescript
import { Controller, Post, Body } from '@nestjs/common';
import { CreateUserDto } from './dto/create-user.dto';

@Controller('users')
export class UsersController {
  @Post()
  create(@Body() createUserDto: CreateUserDto) {
    return `This action creates a user with name: ${createUserDto.name}, email: ${createUserDto.email}`;
  }
}
```

### 5.4 请求头

请求头用于获取 HTTP 请求的头信息，使用 `@Headers()` 装饰器来获取。

```typescript
import { Controller, Get, Headers } from '@nestjs/common';

@Controller('users')
export class UsersController {
  @Get()
  findAll(@Headers() headers: any) {
    return `This action returns all users with headers: ${JSON.stringify(headers)}`;
  }
}
```

你也可以指定请求头的名称：

```typescript
@Get()
findAll(@Headers('authorization') authorization: string) {
  return `This action returns all users with authorization: ${authorization}`;
}
```

### 5.5 请求对象

请求对象用于获取完整的 HTTP 请求对象，使用 `@Req()` 装饰器来获取。

```typescript
import { Controller, Get, Req } from '@nestjs/common';
import { Request } from 'express';

@Controller('users')
export class UsersController {
  @Get()
  findAll(@Req() req: Request) {
    return `This action returns all users with request: ${JSON.stringify(req.query)}`;
  }
}
```

### 5.6 响应对象

响应对象用于自定义 HTTP 响应，使用 `@Res()` 装饰器来获取。

```typescript
import { Controller, Get, Res } from '@nestjs/common';
import { Response } from 'express';

@Controller('users')
export class UsersController {
  @Get()
  findAll(@Res() res: Response) {
    res.status(200).json({
      message: 'This action returns all users',
      data: [],
    });
  }
}
```

## 6. 路由通配符

NestJS 支持路由通配符，可以使用 `*`、`?`、`+` 等通配符来匹配路由。

```typescript
@Controller('users')
export class UsersController {
  // 匹配 "users/123"、"users/abc" 等
  @Get(':id')
  findOne(@Param('id') id: string) {
    return `This action returns user #${id}`;
  }

  // 匹配 "users/profile/123"、"users/profile/abc" 等
  @Get('profile/:id')
  getProfile(@Param('id') id: string) {
    return `This action returns profile for user #${id}`;
  }

  // 匹配 "users/search"、"users/search/123"、"users/search/abc/def" 等
  @Get('search/*')
  search() {
    return 'This action searches for users';
  }
}
```

## 7. 状态码

默认情况下，NestJS 会根据 HTTP 请求方法自动设置状态码：

- GET 请求：200 OK
- POST 请求：201 Created
- PUT 请求：200 OK
- DELETE 请求：200 OK

你可以使用 `@HttpCode()` 装饰器来自定义状态码：

```typescript
import { Controller, Post, HttpCode, HttpStatus } from '@nestjs/common';

@Controller('users')
export class UsersController {
  @Post()
  @HttpCode(HttpStatus.NO_CONTENT) // 设置状态码为 204 No Content
  create() {
    return 'This action creates a user';
  }
}
```

## 8. 响应头

你可以使用 `@Header()` 装饰器来设置响应头：

```typescript
import { Controller, Get, Header } from '@nestjs/common';

@Controller('users')
export class UsersController {
  @Get()
  @Header('Cache-Control', 'none') // 设置响应头
  findAll() {
    return 'This action returns all users';
  }
}
```

## 9. 重定向

你可以使用 `@Redirect()` 装饰器来实现重定向：

```typescript
import { Controller, Get, Redirect } from '@nestjs/common';

@Controller('users')
export class UsersController {
  @Get('docs')
  @Redirect('https://docs.nestjs.com', 302) // 重定向到 NestJS 文档
  getDocs() {
    // 可以根据条件动态返回重定向 URL 和状态码
    return {
      url: 'https://docs.nestjs.com',
      statusCode: 302,
    };
  }
}
```

## 10. 异步控制器

NestJS 支持异步控制器，你可以使用 `async/await` 语法来处理异步操作：

```typescript
import { Controller, Get } from '@nestjs/common';

@Controller('users')
export class UsersController {
  @Get()
  async findAll() {
    // 模拟异步操作
    const users = await this.getUserFromDatabase();
    return users;
  }

  private async getUserFromDatabase() {
    return new Promise<string[]>((resolve) => {
      setTimeout(() => {
        resolve(['user1', 'user2', 'user3']);
      }, 1000);
    });
  }
}
```

## 11. 响应数据格式

NestJS 支持多种响应数据格式，包括：

- 字符串
- 对象
- 数组
- Promise
- Observable

### 11.1 返回字符串

```typescript
@Get()
findAll() {
  return 'This action returns all users';
}
```

### 11.2 返回对象

```typescript
@Get()
findAll() {
  return {
    message: 'This action returns all users',
    data: [],
  };
}
```

### 11.3 返回数组

```typescript
@Get()
findAll() {
  return ['user1', 'user2', 'user3'];
}
```

### 11.4 返回 Promise

```typescript
@Get()
findAll() {
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve(['user1', 'user2', 'user3']);
    }, 1000);
  });
}
```

### 11.5 返回 Observable

```typescript
import { Observable, of } from 'rxjs';

@Get()
findAll(): Observable<string[]> {
  return of(['user1', 'user2', 'user3']);
}
```

## 12. 路由分组

你可以使用 `@Controller` 装饰器的 `path` 参数来定义路由前缀，实现路由分组：

```typescript
@Controller('api/v1/users') // 定义路由前缀为 "api/v1/users"
export class UsersController {
  @Get() // 完整路由为 "api/v1/users"
  findAll() {
    return 'This action returns all users';
  }

  @Get(':id') // 完整路由为 "api/v1/users/:id"
  findOne(@Param('id') id: string) {
    return `This action returns user #${id}`;
  }
}
```

## 13. 总结

在本章中，我们学习了 NestJS 控制器的基本概念和使用方法，包括：

- 如何创建和注册控制器
- 如何使用请求方法装饰器
- 如何处理路由参数、查询参数、请求体等
- 如何使用路由通配符
- 如何设置状态码和响应头
- 如何实现重定向
- 如何使用异步控制器
- 如何返回不同格式的响应数据
- 如何实现路由分组

控制器是 NestJS 应用的核心组件之一，掌握控制器的使用方法对于构建高效、可扩展的 NestJS 应用至关重要。在下一章中，我们将学习 NestJS 服务的使用方法。
