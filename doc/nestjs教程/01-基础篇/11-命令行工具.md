# 命令行工具

NestJS CLI（命令行界面）是NestJS官方提供的命令行工具，可以帮助开发者快速创建项目、生成组件、运行测试等，极大地提高了开发效率。本文将详细介绍NestJS CLI的安装、配置和使用，特别是如何使用CLI快速创建模块、控制器、服务等组件。

## 1. NestJS CLI概述

### 1.1 什么是NestJS CLI

NestJS CLI是NestJS官方提供的命令行工具，基于TypeScript和Node.js开发，提供了一系列命令来帮助开发者快速构建和管理NestJS应用。

### 1.2 NestJS CLI的重要性

- **提高开发效率**：快速生成代码模板，减少重复工作
- **统一代码风格**：生成的代码遵循NestJS的最佳实践和代码风格
- **简化项目管理**：提供了项目创建、构建、运行、测试等一站式服务
- **支持自定义**：可以通过配置文件自定义CLI的行为
- **生态集成**：与NestJS生态系统无缝集成

### 1.3 NestJS CLI的核心功能

- **项目创建**：创建新的NestJS项目
- **组件生成**：生成控制器、服务、模块、中间件、拦截器等组件
- **项目构建**：构建生产环境的应用程序
- **项目运行**：运行开发服务器和生产服务器
- **测试**：运行单元测试、集成测试和端到端测试
- **文档生成**：生成API文档
- **依赖管理**：管理项目依赖

## 2. 安装NestJS CLI

### 2.1 全局安装

可以通过npm、yarn或pnpm全局安装NestJS CLI：

```bash
# 使用npm
npm install -g @nestjs/cli

# 使用yarn
yarn global add @nestjs/cli

# 使用pnpm
pnpm add -g @nestjs/cli
```

### 2.2 验证安装

安装完成后，可以通过以下命令验证NestJS CLI是否安装成功：

```bash
nest --version
```

如果安装成功，会输出NestJS CLI的版本号，例如：

```
[Nest CLI] 11.0.0
```

### 2.3 本地安装

除了全局安装外，也可以在项目中本地安装NestJS CLI：

```bash
# 使用npm
npm install --save-dev @nestjs/cli

# 使用yarn
yarn add --dev @nestjs/cli

# 使用pnpm
pnpm add --save-dev @nestjs/cli
```

本地安装后，可以通过以下方式使用NestJS CLI：

```bash
# 使用npx
npx nest --version

# 使用yarn
yarn nest --version

# 使用pnpm
pnpm nest --version
```

## 3. NestJS CLI的基本命令

### 3.1 查看帮助

可以通过以下命令查看NestJS CLI的帮助信息：

```bash
# 查看所有命令
nest --help

# 查看特定命令的帮助
nest generate --help
```

### 3.2 创建项目

可以通过以下命令创建新的NestJS项目：

```bash
# 创建新项目
nest new project-name

# 创建新项目，使用特定包管理器
nest new project-name --package-manager npm
nest new project-name --package-manager yarn
nest new project-name --package-manager pnpm

# 创建新项目，跳过依赖安装
nest new project-name --skip-install

# 创建新项目，使用TypeScript strict模式
nest new project-name --strict
```

### 3.3 生成组件

NestJS CLI提供了`generate`命令（简写为`g`）来生成各种组件，如模块、控制器、服务等。

#### 3.3.1 生成模块

```bash
# 生成模块
nest generate module module-name
nest g mo module-name

# 生成带有路径的模块
nest generate module path/to/module-name
nest g mo path/to/module-name

# 生成模块，跳过测试文件
nest generate module module-name --no-spec
nest g mo module-name --no-spec
```

#### 3.3.2 生成控制器

```bash
# 生成控制器
nest generate controller controller-name
nest g co controller-name

# 生成带有路径的控制器
nest generate controller path/to/controller-name
nest g co path/to/controller-name

# 生成控制器，跳过测试文件
nest generate controller controller-name --no-spec
nest g co controller-name --no-spec

# 生成REST风格的控制器
nest generate controller controller-name --rest
nest g co controller-name --rest
```

#### 3.3.3 生成服务

```bash
# 生成服务
nest generate service service-name
nest g s service-name

# 生成带有路径的服务
nest generate service path/to/service-name
nest g s path/to/service-name

# 生成服务，跳过测试文件
nest generate service service-name --no-spec
nest g s service-name --no-spec
```

#### 3.3.4 生成中间件

```bash
# 生成中间件
nest generate middleware middleware-name
nest g mi middleware-name

# 生成带有路径的中间件
nest generate middleware path/to/middleware-name
nest g mi path/to/middleware-name

# 生成中间件，跳过测试文件
nest generate middleware middleware-name --no-spec
nest g mi middleware-name --no-spec
```

#### 3.3.5 生成拦截器

```bash
# 生成拦截器
nest generate interceptor interceptor-name
nest g in interceptor-name

# 生成带有路径的拦截器
nest generate interceptor path/to/interceptor-name
nest g in path/to/interceptor-name

# 生成拦截器，跳过测试文件
nest generate interceptor interceptor-name --no-spec
nest g in interceptor-name --no-spec
```

#### 3.3.6 生成过滤器

```bash
# 生成过滤器
nest generate filter filter-name
nest g f filter-name

# 生成带有路径的过滤器
nest generate filter path/to/filter-name
nest g f path/to/filter-name

# 生成过滤器，跳过测试文件
nest generate filter filter-name --no-spec
nest g f filter-name --no-spec
```

#### 3.3.7 生成管道

```bash
# 生成管道
nest generate pipe pipe-name
nest g pi pipe-name

# 生成带有路径的管道
nest generate pipe path/to/pipe-name
nest g pi path/to/pipe-name

# 生成管道，跳过测试文件
nest generate pipe pipe-name --no-spec
nest g pi pipe-name --no-spec
```

#### 3.3.8 生成守卫

```bash
# 生成守卫
nest generate guard guard-name
nest g gu guard-name

# 生成带有路径的守卫
nest generate guard path/to/guard-name
nest g gu path/to/guard-name

# 生成守卫，跳过测试文件
nest generate guard guard-name --no-spec
nest g gu guard-name --no-spec

# 生成认证守卫
nest generate guard guard-name --strategy
nest g gu guard-name --strategy
```

#### 3.3.9 生成资源

`resource`命令可以同时生成模块、控制器和服务，是创建完整资源的快捷方式。

```bash
# 生成资源
nest generate resource resource-name
nest g res resource-name

# 生成带有路径的资源
nest generate resource path/to/resource-name
nest g res path/to/resource-name

# 生成资源，跳过测试文件
nest generate resource resource-name --no-spec
nest g res resource-name --no-spec

# 生成REST风格的资源
nest generate resource resource-name --rest
nest g res resource-name --rest

# 生成GraphQL风格的资源
nest generate resource resource-name --graphql
nest g res resource-name --graphql

# 生成资源，不生成CRUD方法
nest generate resource resource-name --no-crud
nest g res resource-name --no-crud
```

### 3.4 运行项目

```bash
# 运行开发服务器，监听文件变化
nest start:dev
nest start --watch

# 运行生产服务器
nest start:prod

# 运行特定端口的服务器
nest start --port 3001

# 运行服务器，使用特定环境变量文件
nest start --env-file .env.production
```

### 3.5 构建项目

```bash
# 构建项目
nest build

# 构建项目，使用特定配置
nest build --config nest-cli.json

# 构建项目，输出到特定目录
nest build --output dist

# 构建项目，使用特定环境
nest build --mode production
```

### 3.6 运行测试

```bash
# 运行所有测试
nest test

# 运行特定测试文件
nest test --testPathPattern=test-file-name

# 运行测试，监听文件变化
nest test --watch

# 运行测试，生成覆盖率报告
nest test --coverage

# 运行e2e测试
nest e2e

# 运行e2e测试，使用特定配置
nest e2e --config jest-e2e.json
```

### 3.7 其他命令

```bash
# 检查依赖更新
nest update

# 更新特定依赖
nest update @nestjs/core @nestjs/common

# 查看项目信息
nest info

# 查看CLI配置
nest config
```

## 4. 快速创建模块示例

### 4.1 基本模块创建

假设我们要创建一个用户模块，可以使用以下命令：

```bash
# 生成用户模块
nest g mo users
```

这个命令会在`src/users`目录下生成`users.module.ts`文件：

```typescript
import { Module } from '@nestjs/common';

@Module({})
export class UsersModule {}
```

### 4.2 完整资源创建

如果我们要创建一个完整的用户资源，包括模块、控制器和服务，可以使用`resource`命令：

```bash
# 生成用户资源
nest g res users --no-spec
```

这个命令会：

1. 提示选择资源类型（REST API、GraphQL API等）
2. 提示是否生成CRUD端点
3. 生成以下文件：
   - `src/users/users.module.ts`：用户模块
   - `src/users/users.controller.ts`：用户控制器
   - `src/users/users.service.ts`：用户服务
   - `src/users/dto/create-user.dto.ts`：创建用户的DTO
   - `src/users/dto/update-user.dto.ts`：更新用户的DTO
   - `src/users/entities/user.entity.ts`：用户实体

### 4.3 带有路径的模块创建

如果我们要创建一个带有路径的模块，例如`admin/users`，可以使用以下命令：

```bash
# 生成带有路径的用户模块
nest g mo admin/users
```

这个命令会在`src/admin/users`目录下生成`users.module.ts`文件，同时会自动创建`admin`模块（如果不存在）。

### 4.4 生成多层级模块

如果我们要创建一个多层级的模块结构，例如`admin/dashboard/stats`，可以使用以下命令：

```bash
# 生成多层级模块
nest g mo admin/dashboard/stats
```

这个命令会创建以下目录结构和文件：

```
src/
├── admin/
│   ├── admin.module.ts
│   └── dashboard/
│       ├── dashboard.module.ts
│       └── stats/
│           └── stats.module.ts
```

## 5. NestJS CLI配置

### 5.1 nest-cli.json配置文件

NestJS CLI的配置文件是`nest-cli.json`，位于项目根目录下。可以通过修改这个文件来自定义CLI的行为。

```json
{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true,
    "webpack": true,
    "tsConfigPath": "tsconfig.build.json"
  }
}
```

### 5.2 常用配置选项

| 选项 | 类型 | 说明 |
|------|------|------|
| `collection` | `string` | 使用的schematics集合，默认是`@nestjs/schematics` |
| `sourceRoot` | `string` | 源代码根目录，默认是`src` |
| `compilerOptions` | `object` | 编译选项 |
| `compilerOptions.deleteOutDir` | `boolean` | 构建前是否删除输出目录，默认是`false` |
| `compilerOptions.webpack` | `boolean` | 是否使用webpack进行构建，默认是`false` |
| `compilerOptions.tsConfigPath` | `string` | TypeScript配置文件路径，默认是`tsconfig.build.json` |
| `compilerOptions.plugins` | `array` | 编译插件 |
| `compilerOptions.assets` | `array` | 需要复制到输出目录的静态资源 |
| `compilerOptions.watchAssets` | `boolean` | 是否监听静态资源变化，默认是`false` |

### 5.3 自定义Schematics

可以通过创建自定义Schematics来扩展NestJS CLI的功能。自定义Schematics允许开发者创建自己的代码生成模板，以满足特定的项目需求。

## 6. 最佳实践

### 6.1 命名规范

- 使用小写字母和连字符（kebab-case）命名组件，例如：`user-profile`
- 使用复数形式命名资源，例如：`users`、`products`
- 使用清晰、描述性的名称，避免使用缩写

### 6.2 组织代码结构

- 使用模块化的方式组织代码，每个模块包含相关的控制器、服务、DTO等
- 使用`resource`命令创建完整的资源，保持代码结构的一致性
- 合理使用路径，创建清晰的层级结构

### 6.3 配置管理

- 使用环境变量文件管理配置，例如：`.env`、`.env.development`、`.env.production`
- 使用`ConfigModule`加载环境变量
- 避免在代码中硬编码配置

### 6.4 测试

- 为每个组件编写测试用例
- 使用`--no-spec`选项跳过测试文件生成，仅在必要时手动编写测试
- 定期运行测试，确保代码质量

## 7. 常见问题与解决方案

### 7.1 CLI命令不生效

**问题**：运行`nest`命令时提示"command not found"

**解决方案**：
- 检查Nest CLI是否正确安装
- 检查Node.js和npm是否在PATH环境变量中
- 尝试使用`npx nest`或`yarn nest`命令
- 重新安装Nest CLI

### 7.2 生成的代码不符合预期

**问题**：使用CLI生成的代码不符合项目的代码风格或结构

**解决方案**：
- 修改`nest-cli.json`配置文件，自定义生成规则
- 创建自定义Schematics
- 手动修改生成的代码，使其符合项目规范

### 7.3 生成的组件没有被正确注册

**问题**：生成的组件没有被自动注册到模块中

**解决方案**：
- 检查模块文件，确保组件被添加到`controllers`或`providers`数组中
- 使用`resource`命令生成完整资源，自动处理注册
- 手动将组件添加到模块中

### 7.4 CLI版本与Nest版本不兼容

**问题**：CLI版本与Nest版本不兼容，导致命令失败

**解决方案**：
- 检查CLI版本和Nest版本是否兼容
- 更新CLI到最新版本
- 使用本地安装的CLI，确保版本匹配

## 8. 总结

NestJS CLI是NestJS开发中不可或缺的工具，它可以帮助开发者快速创建项目、生成组件、运行测试等，极大地提高了开发效率。通过本文的学习，你应该掌握了：

- NestJS CLI的安装和配置
- 如何使用CLI生成各种组件，如模块、控制器、服务等
- 如何使用`resource`命令快速创建完整资源
- 如何运行和构建项目
- 如何配置CLI以满足特定需求
- 最佳实践和常见问题的解决方案

在实际开发中，合理使用NestJS CLI可以显著提高开发效率，保持代码风格的一致性，减少重复工作。建议开发者深入学习和掌握NestJS CLI的使用，以便更好地构建和管理NestJS应用。