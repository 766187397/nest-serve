# 配置管理

## 1. 配置管理简介

配置管理是应用开发中的重要环节，用于管理应用在不同环境下的配置信息。NestJS 提供了多种配置管理方式，包括环境变量、配置文件、配置服务等。

### 1.1 配置管理的重要性

- **环境隔离**：不同环境（开发、测试、生产）使用不同的配置
- **集中管理**：将配置集中管理，便于维护和更新
- **动态更新**：支持配置的动态更新，无需重启应用
- **安全性**：敏感配置（如数据库密码、API 密钥）可以安全存储
- **可扩展性**：支持多种配置源，便于扩展

## 2. 环境变量配置

### 2.1 安装依赖

```bash
# 安装配置管理相关依赖
npm install @nestjs/config dotenv
```

### 2.2 配置 `.env` 文件

```env
# .env
# 应用配置
APP_PORT=3000
APP_ENV=development
APP_NAME=NestJS-API

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=password
DB_DATABASE=nest_demo
DB_SYNCHRONIZE=true
DB_LOGGING=false

# JWT 配置
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=24h

# CORS 配置
CORS_ORIGIN=*

# 上传配置
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=52428800
```

### 2.3 注册 Config 模块

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true, // 全局模块
      envFilePath: '.env', // 环境变量文件路径
      expandVariables: true, // 支持变量扩展
    }),
    // 其他模块
  ],
})
export class AppModule {}
```

### 2.4 使用配置

#### 2.4.1 注入 ConfigService

```typescript
// src/module/users/users.service.ts
import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class UsersService {
  constructor(private configService: ConfigService) {
    // 获取配置
    const appName = this.configService.get<string>('APP_NAME');
    const dbHost = this.configService.get<string>('DB_HOST');
    const dbPort = this.configService.get<number>('DB_PORT', 3306); // 带默认值
    
    console.log(`应用名称: ${appName}`);
    console.log(`数据库主机: ${dbHost}:${dbPort}`);
  }
}
```

#### 2.4.2 配置类

```typescript
// src/config/database.config.ts
// 数据库配置类，首次出现，详细注释说明
import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { TypeOrmModuleOptions } from '@nestjs/typeorm';
import { join } from 'path';

@Injectable()
export class DatabaseConfig {
  constructor(private configService: ConfigService) {}

  getTypeOrmConfig(): TypeOrmModuleOptions {
    return {
      type: 'mysql',
      host: this.configService.get<string>('DB_HOST'),
      port: this.configService.get<number>('DB_PORT'),
      username: this.configService.get<string>('DB_USERNAME'),
      password: this.configService.get<string>('DB_PASSWORD'),
      database: this.configService.get<string>('DB_DATABASE'),
      entities: [join(__dirname, '..', '**', '*.entity{.ts,.js}')],
      synchronize: this.configService.get<boolean>('DB_SYNCHRONIZE'),
      logging: this.configService.get<boolean>('DB_LOGGING'),
      autoLoadEntities: true,
      charset: 'utf8mb4',
      timezone: '+08:00',
    };
  }
}
```

#### 2.4.3 使用配置类

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { TypeOrmModule } from '@nestjs/typeorm';
import { DatabaseConfig } from './config/database.config';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      envFilePath: '.env',
    }),
    TypeOrmModule.forRootAsync({
      useClass: DatabaseConfig,
      inject: [DatabaseConfig],
      useFactory: (databaseConfig: DatabaseConfig) => databaseConfig.getTypeOrmConfig(),
    }),
    // 其他模块
  ],
  providers: [DatabaseConfig],
})
export class AppModule {}
```

## 3. 多环境配置

### 3.1 创建多环境配置文件

```bash
# 开发环境
.env.development
# 测试环境
.env.test
# 生产环境
.env.production
```

### 3.2 配置不同环境的 `.env` 文件

```env
# .env.development
APP_PORT=3000
APP_ENV=development
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=password
DB_DATABASE=nest_demo_dev
DB_SYNCHRONIZE=true
DB_LOGGING=true
```

```env
# .env.production
APP_PORT=8080
APP_ENV=production
DB_HOST=db.example.com
DB_PORT=3306
DB_USERNAME=prod_user
DB_PASSWORD=prod_password
DB_DATABASE=nest_demo_prod
DB_SYNCHRONIZE=false
DB_LOGGING=false
```

### 3.3 加载对应环境的配置文件

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { join } from 'path';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      envFilePath: [
        // 加载对应环境的配置文件
        join(process.cwd(), `.env.${process.env.NODE_ENV || 'development'}`),
        // 加载基础配置文件
        join(process.cwd(), '.env'),
      ],
      // 覆盖模式：后面的配置会覆盖前面的配置
      ignoreEnvFile: false,
    }),
    // 其他模块
  ],
})
export class AppModule {}
```

### 3.4 启动应用时指定环境

```bash
# 开发环境
NODE_ENV=development npm run start:dev

# 生产环境
NODE_ENV=production npm run start:prod
```

## 4. 配置验证

### 4.1 使用 Joi 验证配置

```bash
# 安装 Joi 依赖
npm install joi
```

### 4.2 创建配置验证模式

```typescript
// src/config/config.schema.ts
// 配置验证模式，首次出现，详细注释说明
import * as Joi from 'joi';

export const configSchema = Joi.object({
  // 应用配置
  APP_PORT: Joi.number().default(3000),
  APP_ENV: Joi.string().valid('development', 'test', 'production').default('development'),
  APP_NAME: Joi.string().default('NestJS-API'),
  
  // 数据库配置
  DB_HOST: Joi.string().required(),
  DB_PORT: Joi.number().default(3306),
  DB_USERNAME: Joi.string().required(),
  DB_PASSWORD: Joi.string().required(),
  DB_DATABASE: Joi.string().required(),
  DB_SYNCHRONIZE: Joi.boolean().default(false),
  DB_LOGGING: Joi.boolean().default(false),
  
  // JWT 配置
  JWT_SECRET: Joi.string().required(),
  JWT_EXPIRES_IN: Joi.string().default('24h'),
  
  // CORS 配置
  CORS_ORIGIN: Joi.string().default('*'),
  
  // 上传配置
  UPLOAD_PATH: Joi.string().default('./uploads'),
  MAX_FILE_SIZE: Joi.number().default(52428800),
});
```

### 4.3 应用配置验证

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { configSchema } from './config/config.schema';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      envFilePath: '.env',
      validationSchema: configSchema, // 配置验证模式
      validationOptions: {
        abortEarly: false, // 验证失败时显示所有错误
        allowUnknown: true, // 允许未知的环境变量
        skipUndefined: false, // 跳过未定义的环境变量
      },
    }),
    // 其他模块
  ],
})
export class AppModule {}
```

## 5. 配置服务

### 5.1 创建配置服务

```typescript
// src/config/config.service.ts
// 配置服务，首次出现，详细注释说明
import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

export interface AppConfig {
  port: number;
  env: string;
  name: string;
}

export interface DatabaseConfig {
  host: string;
  port: number;
  username: string;
  password: string;
  database: string;
  synchronize: boolean;
  logging: boolean;
}

export interface JwtConfig {
  secret: string;
  expiresIn: string;
}

export interface UploadConfig {
  path: string;
  maxFileSize: number;
}

@Injectable()
export class AppConfigService {
  constructor(private configService: ConfigService) {}

  // 应用配置
  get appConfig(): AppConfig {
    return {
      port: this.configService.get<number>('APP_PORT'),
      env: this.configService.get<string>('APP_ENV'),
      name: this.configService.get<string>('APP_NAME'),
    };
  }

  // 数据库配置
  get databaseConfig(): DatabaseConfig {
    return {
      host: this.configService.get<string>('DB_HOST'),
      port: this.configService.get<number>('DB_PORT'),
      username: this.configService.get<string>('DB_USERNAME'),
      password: this.configService.get<string>('DB_PASSWORD'),
      database: this.configService.get<string>('DB_DATABASE'),
      synchronize: this.configService.get<boolean>('DB_SYNCHRONIZE'),
      logging: this.configService.get<boolean>('DB_LOGGING'),
    };
  }

  // JWT 配置
  get jwtConfig(): JwtConfig {
    return {
      secret: this.configService.get<string>('JWT_SECRET'),
      expiresIn: this.configService.get<string>('JWT_EXPIRES_IN'),
    };
  }

  // 上传配置
  get uploadConfig(): UploadConfig {
    return {
      path: this.configService.get<string>('UPLOAD_PATH'),
      maxFileSize: this.configService.get<number>('MAX_FILE_SIZE'),
    };
  }

  // CORS 配置
  get corsOrigin(): string {
    return this.configService.get<string>('CORS_ORIGIN');
  }
}
```

### 5.2 使用配置服务

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { AppConfigService } from './config/config.service';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  // 获取配置服务
  const configService = app.get(AppConfigService);
  const appConfig = configService.appConfig;
  
  // 配置 CORS
  app.enableCors({
    origin: configService.corsOrigin,
    credentials: true,
  });
  
  // 启动应用
  await app.listen(appConfig.port, () => {
    console.log(`应用 ${appConfig.name} 已启动，运行在 http://localhost:${appConfig.port}`);
    console.log(`当前环境：${appConfig.env}`);
  });
}
bootstrap();
```

## 6. 配置动态更新

### 6.1 安装配置动态更新依赖

```bash
# 安装配置动态更新依赖
npm install config-manager
```

### 6.2 实现配置动态更新

```typescript
// src/config/dynamic-config.service.ts
// 动态配置服务，首次出现，详细注释说明
import { Injectable, OnModuleInit } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import * as fs from 'fs';
import * as path from 'path';

@Injectable()
export class DynamicConfigService implements OnModuleInit {
  private configCache: Record<string, any> = {};
  private envFilePath: string;

  constructor(private configService: ConfigService) {
    this.envFilePath = path.join(process.cwd(), `.env.${process.env.NODE_ENV || 'development'}`);
  }

  // 模块初始化时加载配置
  onModuleInit() {
    this.loadConfig();
    this.watchConfig();
  }

  // 加载配置
  private loadConfig() {
    const envContent = fs.readFileSync(this.envFilePath, 'utf8');
    const lines = envContent.split('\n');
    
    this.configCache = {};
    for (const line of lines) {
      if (line.trim() && !line.startsWith('#')) {
        const [key, ...values] = line.split('=');
        const value = values.join('=').trim();
        this.configCache[key.trim()] = value;
      }
    }
  }

  // 监听配置文件变化
  private watchConfig() {
    fs.watch(this.envFilePath, (eventType) => {
      if (eventType === 'change') {
        console.log('配置文件已更改，重新加载配置...');
        this.loadConfig();
      }
    });
  }

  // 获取配置
  get(key: string): any {
    return this.configCache[key] || this.configService.get(key);
  }

  // 设置配置
  set(key: string, value: any): void {
    this.configCache[key] = value;
    this.saveConfig();
  }

  // 保存配置到文件
  private saveConfig() {
    let envContent = '';
    for (const [key, value] of Object.entries(this.configCache)) {
      envContent += `${key}=${value}\n`;
    }
    fs.writeFileSync(this.envFilePath, envContent, 'utf8');
  }
}
```

## 7. 配置最佳实践

1. **使用环境变量**：将敏感配置和环境特定配置放在环境变量中
2. **使用配置服务**：创建统一的配置服务，便于管理和使用配置
3. **配置验证**：使用 Joi 等工具验证配置的有效性
4. **多环境配置**：为不同环境创建不同的配置文件
5. **配置集中管理**：将配置集中管理，便于维护和更新
6. **配置版本控制**：将配置文件纳入版本控制，但不包含敏感信息
7. **敏感信息加密**：敏感配置（如数据库密码、API 密钥）可以使用加密存储
8. **配置文档**：为配置项添加文档说明，便于其他开发者理解
9. **配置监控**：监控配置的变化，及时发现问题
10. **配置备份**：定期备份配置文件，防止配置丢失

## 8. 常见问题

### 8.1 配置文件不生效

**问题**：修改了 `.env` 文件，但配置没有生效。

**解决方案**：
1. 检查配置文件路径是否正确
2. 检查配置文件格式是否正确
3. 检查配置项名称是否正确
4. 重启应用服务

### 8.2 配置验证失败

**问题**：启动应用时，配置验证失败。

**解决方案**：
1. 检查配置文件中的配置项是否符合验证规则
2. 检查是否缺少必填配置项
3. 检查配置项的值是否在允许范围内

### 8.3 多环境配置冲突

**问题**：不同环境的配置文件之间存在冲突。

**解决方案**：
1. 确保不同环境的配置文件使用不同的配置值
2. 明确配置文件的加载顺序
3. 使用 `ConfigModule` 的 `expandVariables` 选项支持变量扩展

### 8.4 敏感配置泄露

**问题**：敏感配置（如数据库密码）泄露。

**解决方案**：
1. 不要将敏感配置硬编码到代码中
2. 不要将包含敏感配置的 `.env` 文件提交到版本控制
3. 使用环境变量或配置服务管理敏感配置
4. 对敏感配置进行加密存储

## 9. 总结

配置管理是应用开发中的重要环节，NestJS 提供了多种配置管理方式，包括环境变量、配置文件、配置服务等。合理使用这些配置管理方式，可以提高应用的可维护性、可扩展性和安全性。在实际应用中，我们需要根据项目需求选择合适的配置管理方式，并遵循最佳实践，确保配置的安全性和可靠性。
