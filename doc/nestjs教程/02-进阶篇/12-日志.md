# 日志

日志是应用程序中重要的组成部分，用于记录应用程序的运行状态、错误信息、调试信息等。良好的日志系统可以帮助开发者快速定位问题，监控应用程序的运行状况，分析用户行为等。NestJS提供了强大的日志支持，可以轻松实现各种日志需求。

## 1. 日志的概念

### 1.1 什么是日志

日志是应用程序运行时产生的记录，包含了应用程序的各种信息，如：

- 运行状态信息
- 错误和异常信息
- 调试信息
- 用户行为信息
- 系统事件信息

### 1.2 日志的重要性

- **问题定位**：快速定位和解决应用程序中的问题
- **监控告警**：监控应用程序的运行状况，及时发现异常
- **性能分析**：分析应用程序的性能瓶颈
- **安全审计**：记录系统的安全事件，便于审计
- **用户行为分析**：分析用户的行为模式
- **合规性要求**：满足某些行业的合规性要求

### 1.3 日志的级别

常见的日志级别包括：

- **DEBUG**：调试信息，用于开发和调试
- **INFO**：一般信息，记录应用程序的正常运行状态
- **WARN**：警告信息，记录潜在的问题
- **ERROR**：错误信息，记录应用程序的错误
- **FATAL**：致命错误，记录导致应用程序崩溃的错误

### 1.4 日志的格式

常见的日志格式包括：

- **文本格式**：人类可读的文本格式
- **JSON格式**：结构化的JSON格式，便于机器处理
- **自定义格式**：根据需求自定义的格式

## 2. NestJS内置的日志系统

NestJS提供了内置的日志系统，可以轻松实现各种日志需求。

### 2.1 日志服务

NestJS的日志系统基于`Logger`服务，位于`@nestjs/common`包中。

#### 2.1.1 基本使用

```typescript
// src/modules/app/app.controller.ts
import { Controller, Get } from '@nestjs/common';
import { Logger } from '@nestjs/common';

@Controller()
export class AppController {
  // 创建Logger实例，指定上下文
  private readonly logger = new Logger(AppController.name);
  
  @Get()
  getHello(): string {
    // 记录日志
    this.logger.log('Hello World!');
    this.logger.warn('警告信息');
    this.logger.error('错误信息');
    this.logger.debug('调试信息');
    this.logger.verbose('详细信息');
    
    return 'Hello World!';
  }
}
```

#### 2.1.2 日志级别

NestJS支持以下日志级别：

- **log**：记录一般信息
- **warn**：记录警告信息
- **error**：记录错误信息
- **debug**：记录调试信息
- **verbose**：记录详细信息

### 2.2 全局日志配置

可以在应用程序初始化时配置全局日志选项：

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { Logger } from '@nestjs/common';

async function bootstrap() {
  // 创建应用实例，配置日志选项
  const app = await NestFactory.create(AppModule, {
    logger: {
      // 日志级别，可选值：false, 'error', 'warn', 'log', 'debug', 'verbose'
      level: 'log',
      // 是否禁用颜色
      disableColors: false,
      // 日志时间戳
      timestamp: true,
    },
  });
  
  await app.listen(3000);
  
  // 记录启动信息
  const logger = new Logger('bootstrap');
  logger.log('应用程序已启动，监听端口 3000');
}
bootstrap();
```

### 2.3 日志配置选项

NestJS的日志配置选项包括：

| 选项 | 类型 | 说明 |
|------|------|------|
| `level` | `string` | 日志级别，可选值：false, 'error', 'warn', 'log', 'debug', 'verbose' |
| `disableColors` | `boolean` | 是否禁用颜色 |
| `timestamp` | `boolean` | 是否显示时间戳 |
| `prettyPrint` | `boolean` | 是否美化输出格式 |
| `colors` | `object` | 自定义日志颜色 |
| `stream` | `WriteStream` | 日志输出流 |
| `context` | `string` | 日志上下文 |

## 3. 自定义日志器

NestJS允许自定义日志器，以满足不同的需求。

### 3.1 实现自定义日志器

要实现自定义日志器，需要实现`LoggerService`接口：

```typescript
// src/modules/logger/custom.logger.ts
import { LoggerService } from '@nestjs/common';

// 实现LoggerService接口
export class CustomLogger implements LoggerService {
  log(message: string, context?: string): void {
    console.log(`[LOG] [${context}] ${message}`);
  }
  
  warn(message: string, context?: string): void {
    console.warn(`[WARN] [${context}] ${message}`);
  }
  
  error(message: string, trace?: string, context?: string): void {
    console.error(`[ERROR] [${context}] ${message}`);
    if (trace) {
      console.error(`[ERROR] [${context}] ${trace}`);
    }
  }
  
  debug(message: string, context?: string): void {
    console.debug(`[DEBUG] [${context}] ${message}`);
  }
  
  verbose(message: string, context?: string): void {
    console.log(`[VERBOSE] [${context}] ${message}`);
  }
}
```

### 3.2 注册自定义日志器

在应用程序初始化时注册自定义日志器：

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { CustomLogger } from './modules/logger/custom.logger';

async function bootstrap() {
  // 创建应用实例，使用自定义日志器
  const app = await NestFactory.create(AppModule, {
    logger: new CustomLogger(),
  });
  
  await app.listen(3000);
}
bootstrap();
```

### 3.3 全局使用自定义日志器

可以在模块中全局注册自定义日志器：

```typescript
// src/modules/logger/logger.module.ts
import { Module, Global } from '@nestjs/common';
import { CustomLogger } from './custom.logger';

@Global() // 全局模块
@Module({
  providers: [
    {
      provide: 'CustomLogger',
      useClass: CustomLogger,
    },
  ],
  exports: ['CustomLogger'], // 导出自定义日志器
})
export class LoggerModule {}
```

在控制器或服务中使用自定义日志器：

```typescript
// src/modules/app/app.controller.ts
import { Controller, Get, Inject } from '@nestjs/common';
import { LoggerService } from '@nestjs/common';

@Controller()
export class AppController {
  constructor(
    // 注入自定义日志器
    @Inject('CustomLogger') private readonly logger: LoggerService,
  ) {}
  
  @Get()
  getHello(): string {
    this.logger.log('Hello World!', AppController.name);
    return 'Hello World!';
  }
}
```

## 4. 使用第三方日志库

NestJS允许使用第三方日志库，如Winston、Pino等。

### 4.1 使用Winston

Winston是一个流行的Node.js日志库，支持多种传输方式和格式化选项。

#### 4.1.1 安装依赖

```bash
npm install winston @nestjs/logger
```

#### 4.1.2 实现Winston日志器

```typescript
// src/modules/logger/winston.logger.ts
import { LoggerService } from '@nestjs/common';
import { createLogger, format, transports } from 'winston';

// 实现LoggerService接口
export class WinstonLogger implements LoggerService {
  private logger;
  
  constructor() {
    // 配置Winston
    this.logger = createLogger({
      level: process.env.LOG_LEVEL || 'info',
      format: format.combine(
        format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        format.errors({ stack: true }),
        format.splat(),
        format.json(),
      ),
      defaultMeta: { service: 'nestjs-app' },
      transports: [
        // 控制台输出
        new transports.Console({
          format: format.combine(
            format.colorize(),
            format.simple(),
          ),
        }),
        // 文件输出 - 错误日志
        new transports.File({
          filename: 'logs/error.log',
          level: 'error',
        }),
        // 文件输出 - 所有日志
        new transports.File({
          filename: 'logs/combined.log',
        }),
      ],
    });
  }
  
  log(message: string, context?: string): void {
    this.logger.info(message, { context });
  }
  
  warn(message: string, context?: string): void {
    this.logger.warn(message, { context });
  }
  
  error(message: string, trace?: string, context?: string): void {
    this.logger.error(message, { context, trace });
  }
  
  debug(message: string, context?: string): void {
    this.logger.debug(message, { context });
  }
  
  verbose(message: string, context?: string): void {
    this.logger.verbose(message, { context });
  }
}
```

#### 4.1.3 注册Winston日志器

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { WinstonLogger } from './modules/logger/winston.logger';

async function bootstrap() {
  // 创建应用实例，使用Winston日志器
  const app = await NestFactory.create(AppModule, {
    logger: new WinstonLogger(),
  });
  
  await app.listen(3000);
}
bootstrap();
```

### 4.2 使用Pino

Pino是一个高性能的Node.js日志库，支持JSON格式输出。

#### 4.2.1 安装依赖

```bash
npm install pino @nestjs/pino pino-pretty
```

#### 4.2.2 配置Pino

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { Logger } from '@nestjs/common';
import { LoggerModule } from '@nestjs/pino';

async function bootstrap() {
  // 创建应用实例，使用Pino日志器
  const app = await NestFactory.create(
    AppModule,
    // 配置Pino
    LoggerModule.forRoot({
      pinoHttp: {
        level: process.env.LOG_LEVEL || 'info',
        transport: {
          target: 'pino-pretty',
          options: {
            singleLine: true,
          },
        },
      },
    }),
  );
  
  await app.listen(3000);
}
bootstrap();
```

## 5. 日志中间件

可以使用中间件来记录HTTP请求日志。

### 5.1 自定义日志中间件

```typescript
// src/middleware/logger.middleware.ts
import { Injectable, NestMiddleware, Logger } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  private readonly logger = new Logger(LoggerMiddleware.name);
  
  use(req: Request, res: Response, next: NextFunction): void {
    // 记录请求开始时间
    const start = Date.now();
    const { method, originalUrl, ip } = req;
    const userAgent = req.get('user-agent') || '';
    
    // 监听响应结束事件
    res.on('finish', () => {
      const { statusCode } = res;
      const contentLength = res.get('content-length') || 0;
      const end = Date.now();
      const responseTime = end - start;
      
      // 记录请求日志
      this.logger.log(
        `${method} ${originalUrl} ${statusCode} ${contentLength} - ${userAgent} ${ip} ${responseTime}ms`,
      );
    });
    
    next();
  }
}
```

### 5.2 注册日志中间件

在模块中注册日志中间件：

```typescript
// src/modules/app/app.module.ts
import { Module, NestModule, MiddlewareConsumer } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { LoggerMiddleware } from '../../middleware/logger.middleware';

@Module({
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    // 注册日志中间件，应用到所有路由
    consumer.apply(LoggerMiddleware).forRoutes('*');
  }
}
```

## 6. 生产环境日志配置

在生产环境中，需要特别注意日志的配置，以确保日志的可靠性和性能。

### 6.1 日志级别

在生产环境中，建议使用`info`或`warn`级别，避免记录过多的调试信息。

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { WinstonLogger } from './modules/logger/winston.logger';

async function bootstrap() {
  // 获取环境变量中的日志级别
  const logLevel = process.env.LOG_LEVEL || 'info';
  
  // 创建应用实例，使用Winston日志器
  const app = await NestFactory.create(AppModule, {
    logger: new WinstonLogger(logLevel),
  });
  
  await app.listen(3000);
}
bootstrap();
```

### 6.2 日志文件滚动

在生产环境中，建议使用日志文件滚动，避免日志文件过大。

```typescript
// src/modules/logger/winston.logger.ts
import { LoggerService } from '@nestjs/common';
import { createLogger, format, transports } from 'winston';
import 'winston-daily-rotate-file'; // 日志文件滚动

// 实现LoggerService接口
export class WinstonLogger implements LoggerService {
  private logger;
  
  constructor(logLevel = 'info') {
    // 配置Winston
    this.logger = createLogger({
      level: logLevel,
      format: format.combine(
        format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        format.errors({ stack: true }),
        format.splat(),
        format.json(),
      ),
      defaultMeta: { service: 'nestjs-app' },
      transports: [
        // 控制台输出
        new transports.Console({
          format: format.combine(
            format.colorize(),
            format.simple(),
          ),
        }),
        // 文件输出 - 错误日志（滚动）
        new transports.DailyRotateFile({
          filename: 'logs/error-%DATE%.log',
          datePattern: 'YYYY-MM-DD',
          zippedArchive: true,
          maxSize: '20m',
          maxFiles: '14d',
          level: 'error',
        }),
        // 文件输出 - 所有日志（滚动）
        new transports.DailyRotateFile({
          filename: 'logs/combined-%DATE%.log',
          datePattern: 'YYYY-MM-DD',
          zippedArchive: true,
          maxSize: '20m',
          maxFiles: '14d',
        }),
      ],
    });
  }
  
  // 其他方法...
}
```

### 6.3 日志监控

在生产环境中，建议使用日志监控工具，如ELK Stack、Splunk等，实时监控日志。

## 7. 日志最佳实践

### 7.1 日志设计原则

- **清晰明确**：日志信息应清晰明确，便于理解
- **结构化**：使用结构化的日志格式，便于机器处理
- **包含上下文**：日志应包含足够的上下文信息
- **适当的级别**：根据日志的重要性选择适当的级别
- **避免敏感信息**：避免在日志中记录敏感信息，如密码、API密钥等
- **适当的频率**：避免记录过多的日志，影响性能

### 7.2 日志内容建议

- **请求日志**：记录HTTP请求的方法、URL、状态码、响应时间等
- **错误日志**：记录错误信息、堆栈跟踪等
- **业务日志**：记录业务流程的关键节点
- **系统日志**：记录系统的运行状态、配置信息等
- **安全日志**：记录系统的安全事件，如登录、权限变更等

### 7.3 性能优化

- **异步日志**：使用异步日志，避免阻塞主流程
- **批量写入**：批量写入日志，减少IO操作
- **适当的级别**：避免记录过多的调试信息
- **日志过滤**：根据需求过滤日志
- **使用高性能日志库**：使用高性能的日志库，如Pino

### 7.4 安全性

- **加密敏感数据**：敏感数据应加密存储
- **限制日志访问权限**：限制日志文件的访问权限
- **定期清理日志**：定期清理过期的日志文件
- **审计日志**：记录日志系统的操作日志

## 8. 完整示例

### 8.1 Winston日志器完整示例

```typescript
// src/modules/logger/winston.logger.ts
import { LoggerService } from '@nestjs/common';
import { createLogger, format, transports } from 'winston';
import 'winston-daily-rotate-file';

export class WinstonLogger implements LoggerService {
  private logger;
  
  constructor(logLevel = 'info') {
    this.logger = createLogger({
      level: logLevel,
      format: format.combine(
        format.timestamp({
          format: 'YYYY-MM-DD HH:mm:ss',
        }),
        format.errors({ stack: true }),
        format.splat(),
        format.json(),
      ),
      defaultMeta: { service: 'nestjs-app' },
      transports: [
        new transports.Console({
          format: format.combine(
            format.colorize(),
            format.simple(),
          ),
        }),
        new transports.DailyRotateFile({
          filename: 'logs/error-%DATE%.log',
          datePattern: 'YYYY-MM-DD',
          zippedArchive: true,
          maxSize: '20m',
          maxFiles: '14d',
          level: 'error',
        }),
        new transports.DailyRotateFile({
          filename: 'logs/combined-%DATE%.log',
          datePattern: 'YYYY-MM-DD',
          zippedArchive: true,
          maxSize: '20m',
          maxFiles: '14d',
        }),
      ],
    });
  }
  
  log(message: string, context?: string): void {
    this.logger.info(message, { context });
  }
  
  warn(message: string, context?: string): void {
    this.logger.warn(message, { context });
  }
  
  error(message: string, trace?: string, context?: string): void {
    this.logger.error(message, { context, trace });
  }
  
  debug(message: string, context?: string): void {
    this.logger.debug(message, { context });
  }
  
  verbose(message: string, context?: string): void {
    this.logger.verbose(message, { context });
  }
}
```

```typescript
// src/modules/logger/logger.module.ts
import { Module, Global } from '@nestjs/common';
import { WinstonLogger } from './winston.logger';

@Global()
@Module({
  providers: [
    {
      provide: 'WinstonLogger',
      useFactory: () => {
        return new WinstonLogger(process.env.LOG_LEVEL || 'info');
      },
    },
  ],
  exports: ['WinstonLogger'],
})
export class LoggerModule {}
```

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from './modules/app/app.controller';
import { AppService } from './modules/app/app.service';
import { LoggerModule } from './modules/logger/logger.module';

@Module({
  imports: [LoggerModule], // 导入日志模块
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

```typescript
// src/modules/app/app.controller.ts
import { Controller, Get, Inject } from '@nestjs/common';
import { LoggerService } from '@nestjs/common';

@Controller()
export class AppController {
  constructor(
    private readonly appService: AppService,
    @Inject('WinstonLogger') private readonly logger: LoggerService,
  ) {}
  
  @Get()
  getHello(): string {
    this.logger.log('Hello World!', AppController.name);
    return this.appService.getHello();
  }
}
```

## 9. 常见问题与解决方案

### 9.1 日志不输出

**问题**：日志不输出

**解决方案**：
- 检查日志级别是否正确
- 检查日志器是否被正确注册
- 检查日志输出流是否正常
- 检查是否有错误导致日志器无法正常工作

### 9.2 日志性能问题

**问题**：日志影响应用程序性能

**解决方案**：
- 使用异步日志
- 减少日志级别
- 批量写入日志
- 使用高性能日志库
- 避免在日志中执行复杂的计算

### 9.3 日志文件过大

**问题**：日志文件过大，占用过多磁盘空间

**解决方案**：
- 使用日志文件滚动
- 定期清理日志文件
- 压缩归档旧日志文件
- 限制日志文件的大小

### 9.4 日志包含敏感信息

**问题**：日志中包含敏感信息，如密码、API密钥等

**解决方案**：
- 在日志中过滤敏感信息
- 加密敏感数据
- 使用占位符替换敏感信息
- 避免在日志中记录敏感信息

## 10. 总结

日志是应用程序中重要的组成部分，用于记录应用程序的运行状态、错误信息、调试信息等。NestJS提供了强大的日志支持，可以轻松实现各种日志需求。

通过本教程的学习，你已经掌握了：

- NestJS内置的日志系统
- 如何使用Logger服务记录日志
- 如何自定义日志器
- 如何使用第三方日志库（Winston、Pino）
- 如何实现日志中间件
- 生产环境日志配置
- 日志最佳实践

在实际开发中，我们应该根据需求选择合适的日志方案，设计可靠、高效、可监控的日志系统，确保系统的稳定运行。通过合理使用日志，可以提高应用程序的可维护性和可靠性，快速定位和解决问题。