# 部署方案

在开发完成NestJS应用后，下一步是将应用部署到生产环境。本章节将详细介绍NestJS应用的各种部署方案，包括Docker容器化部署、Zeabur平台部署、云平台部署等，并提供最佳实践建议。

## 1. 部署前准备

### 1.1 构建生产版本

在部署前，需要先构建NestJS应用的生产版本：

```bash
# 安装依赖
npm install

# 构建生产版本
npm run build
```

构建完成后，会在`dist`目录生成编译后的JavaScript文件。

### 1.2 环境配置

生产环境需要单独的配置文件或环境变量。建议使用`.env`文件管理环境变量：

```bash
# 创建生产环境配置文件
cp .env.example .env.production
```

在`.env.production`文件中配置生产环境的数据库连接、端口、密钥等信息：

```
# 应用配置
PORT=3000
NODE_ENV=production

# 数据库配置
DB_HOST=db.example.com
DB_PORT=3306
DB_USERNAME=production_user
DB_PASSWORD=secure_password
DB_DATABASE=production_db

# JWT配置
JWT_SECRET=your_production_jwt_secret
JWT_EXPIRATION=3600
```

## 2. Docker容器化部署

Docker是一种流行的容器化技术，可以将应用及其依赖打包成一个容器，实现跨平台部署。

### 2.1 创建Dockerfile

在项目根目录创建`Dockerfile`：

```dockerfile
# Dockerfile
# NestJS应用的Docker构建文件

# 第一阶段：构建应用
FROM node:18-alpine AS builder

# 设置工作目录
WORKDIR /app

# 复制package.json和package-lock.json
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建应用
RUN npm run build

# 第二阶段：运行应用
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制构建产物和依赖
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/.env.production ./.env
COPY --from=builder /app/package.json ./

# 暴露端口
EXPOSE 3000

# 启动命令
CMD ["node", "dist/main"]
```

### 2.2 创建docker-compose.yml

对于需要多个服务（如应用和数据库）的情况，可以使用Docker Compose：

```yaml
# docker-compose.yml
# Docker Compose配置文件，用于管理多个Docker服务
version: '3.8'

services:
  # 应用服务
  app:
    # 构建镜像
    build: .
    # 容器名称
    container_name: nestjs-app
    # 环境变量
    environment:
      - NODE_ENV=production
    # 端口映射
    ports:
      - "3000:3000"
    # 依赖关系
    depends_on:
      - db
    # 重启策略
    restart: unless-stopped
    # 卷挂载
    volumes:
      - ./logs:/app/logs
    # 网络
    networks:
      - nestjs-network

  # 数据库服务
  db:
    # 使用MySQL镜像
    image: mysql:8.0
    # 容器名称
    container_name: nestjs-mysql
    # 环境变量
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=nestjs_db
      - MYSQL_USER=nestjs_user
      - MYSQL_PASSWORD=nestjs_password
    # 端口映射
    ports:
      - "3306:3306"
    # 重启策略
    restart: unless-stopped
    # 卷挂载
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    # 网络
    networks:
      - nestjs-network

# 网络定义
networks:
  nestjs-network:
    driver: bridge

# 卷定义
volumes:
  mysql-data:
    driver: local
```

### 2.3 构建和运行

```bash
# 构建Docker镜像
docker build -t nestjs-app .

# 运行Docker容器
docker run -p 3000:3000 --name nestjs-app nestjs-app

# 使用Docker Compose运行多个服务
docker-compose up -d

# 查看容器状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

## 3. Zeabur平台部署

Zeabur是一个现代化的云平台，可以简化应用部署流程，支持自动构建和部署。

### 3.1 注册和创建项目

1. 访问[Zeabur官网](https://zeabur.com/)注册账号
2. 创建一个新的项目
3. 连接GitHub/GitLab仓库

### 3.2 部署应用

1. 在项目中添加服务
2. 选择GitHub/GitLab上的NestJS仓库
3. Zeabur会自动检测项目类型并配置构建命令
4. 配置环境变量
5. 点击部署按钮开始部署

### 3.3 配置域名

部署完成后，可以配置自定义域名：

1. 在服务设置中找到域名配置
2. 添加自定义域名
3. 根据提示配置DNS解析
4. 等待SSL证书自动生成

### 3.4 数据库配置

Zeabur提供了数据库服务，可以直接在平台上创建数据库：

1. 在项目中添加数据库服务
2. 选择数据库类型（如MySQL、PostgreSQL）
3. 配置数据库名称和密码
4. 获取数据库连接信息
5. 在应用的环境变量中配置数据库连接

## 4. 云平台部署

### 4.1 AWS部署

1. **创建EC2实例**：
   - 选择合适的实例类型和操作系统
   - 配置安全组，开放3000端口
   - 创建密钥对，用于SSH登录

2. **安装Node.js**：
   ```bash
   # 安装nvm
   curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
   
   # 安装Node.js
   nvm install 18
   nvm use 18
   ```

3. **部署应用**：
   ```bash
   # 克隆代码
   git clone https://github.com/your-username/your-nestjs-app.git
   cd your-nestjs-app
   
   # 安装依赖
   npm install
   
   # 构建应用
   npm run build
   
   # 配置环境变量
   cp .env.example .env
   # 编辑.env文件，配置生产环境变量
   
   # 使用PM2启动应用
   npm install -g pm2
   pm2 start dist/main.js --name nestjs-app
   pm2 startup
   pm2 save
   ```

### 4.2 阿里云部署

1. **创建ECS实例**：
   - 选择合适的实例规格和操作系统
   - 配置安全组，开放3000端口
   - 设置登录密码或密钥对

2. **安装Node.js和PM2**：
   ```bash
   # 安装Node.js
   curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
   yum install -y nodejs
   
   # 安装PM2
   npm install -g pm2
   ```

3. **部署应用**：
   ```bash
   # 克隆代码
   git clone https://github.com/your-username/your-nestjs-app.git
   cd your-nestjs-app
   
   # 安装依赖并构建
   npm install
   npm run build
   
   # 配置环境变量
   vi .env
   
   # 启动应用
   pm2 start dist/main.js --name nestjs-app
   pm2 startup
   pm2 save
   ```

4. **配置负载均衡**（可选）：
   - 创建负载均衡实例
   - 配置监听规则，将80/443端口转发到ECS实例的3000端口
   - 配置SSL证书

## 5. 使用PM2管理应用

PM2是一个Node.js应用进程管理器，可以管理应用的启动、停止、重启等，还提供负载均衡和监控功能。

### 5.1 安装PM2

```bash
npm install -g pm2
```

### 5.2 启动应用

```bash
# 启动应用
pm2 start dist/main.js --name nestjs-app

# 查看应用状态
pm2 status

# 查看应用日志
pm2 logs

# 重启应用
pm2 restart nestjs-app

# 停止应用
pm2 stop nestjs-app

# 删除应用
pm2 delete nestjs-app
```

### 5.3 配置PM2

创建`ecosystem.config.js`文件，配置PM2：

```javascript
// ecosystem.config.js
// PM2配置文件，用于管理Node.js应用
module.exports = {
  apps: [
    {
      // 应用名称
      name: 'nestjs-app',
      // 启动脚本
      script: './dist/main.js',
      // 环境变量
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
      },
      // 实例数
      instances: 'max',
      // 负载均衡模式
      exec_mode: 'cluster',
      // 自动重启
      autorestart: true,
      // 日志配置
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
      // 错误日志路径
      error_file: './logs/error.log',
      // 输出日志路径
      out_file: './logs/out.log',
      // 合并日志
      merge_logs: true,
      // 日志大小限制
      max_memory_restart: '1G',
    },
  ],
};
```

使用配置文件启动应用：

```bash
pm2 start ecosystem.config.js
```

## 6. 配置Nginx反向代理

使用Nginx作为反向代理，可以提供负载均衡、SSL终止、静态资源服务等功能。

### 6.1 安装Nginx

```bash
# Ubuntu/Debian
apt update && apt install nginx

# CentOS/RHEL
yum install nginx
```

### 6.2 配置Nginx

创建Nginx配置文件：

```bash
vi /etc/nginx/conf.d/nestjs-app.conf
```

添加以下配置：

```nginx
# /etc/nginx/conf.d/nestjs-app.conf
# Nginx配置文件，用于反向代理NestJS应用

server {
    # 监听80端口
    listen 80;
    # 配置域名
    server_name your-domain.com;

    # 重定向HTTP到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    # 监听443端口
    listen 443 ssl http2;
    # 配置域名
    server_name your-domain.com;

    # SSL配置
    ssl_certificate /path/to/your/ssl/cert.pem;
    ssl_certificate_key /path/to/your/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 静态资源配置
    location /static {
        alias /path/to/your/static/files;
        expires 30d;
    }

    # API请求反向代理
    location / {
        # 代理到NestJS应用
        proxy_pass http://localhost:3000;
        # 代理头配置
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket配置
    location /ws {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 6.3 测试和重启Nginx

```bash
# 测试Nginx配置
nginx -t

# 重启Nginx
systemctl restart nginx

# 查看Nginx状态
systemctl status nginx
```

## 7. 部署最佳实践

### 7.1 环境隔离

- 开发环境、测试环境、生产环境严格隔离
- 使用不同的数据库实例和配置
- 使用不同的密钥和凭证

### 7.2 自动化部署

- 使用CI/CD工具自动化构建和部署流程
- 实现代码推送自动部署
- 配置自动化测试，确保部署质量

### 7.3 监控和日志

- 配置应用日志，包括访问日志、错误日志和业务日志
- 使用监控工具监控应用性能和健康状态
- 设置告警机制，及时发现和处理问题

### 7.4 安全配置

- 使用HTTPS协议，配置SSL证书
- 配置防火墙，限制访问IP和端口
- 定期更新依赖包，修复安全漏洞
- 使用环境变量管理敏感信息，不硬编码到代码中

### 7.5 性能优化

- 启用Gzip压缩
- 使用CDN加速静态资源
- 配置缓存策略
- 使用负载均衡，提高应用可用性和并发处理能力

### 7.6 备份和恢复

- 定期备份数据库和重要文件
- 测试备份恢复流程
- 配置自动备份策略

## 8. CI/CD集成

### 8.1 GitHub Actions

创建`.github/workflows/deploy.yml`文件：

```yaml
# .github/workflows/deploy.yml
# GitHub Actions工作流，用于自动化构建和部署NestJS应用
name: Deploy NestJS App

on:
  # 推送到main分支时触发
  push:
    branches: [ main ]
  # 手动触发
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 检出代码
    - uses: actions/checkout@v3
    
    # 设置Node.js版本
    - name: Use Node.js 18
      uses: actions/setup-node@v3
      with:
        node-version: 18
        cache: 'npm'
    
    # 安装依赖
    - run: npm ci
    
    # 构建应用
    - run: npm run build
    
    # 运行测试
    - run: npm run test:cov
    
    # 登录Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
    
    # 构建并推送Docker镜像
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKER_HUB_USERNAME }}/nestjs-app:latest
  
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    # 部署到服务器
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          # 拉取最新Docker镜像
          docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/nestjs-app:latest
          
          # 停止并移除旧容器
          docker stop nestjs-app || true
          docker rm nestjs-app || true
          
          # 运行新容器
          docker run -d -p 3000:3000 --name nestjs-app \
            --env-file .env.production \
            ${{ secrets.DOCKER_HUB_USERNAME }}/nestjs-app:latest
          
          # 清理无用镜像
          docker system prune -f
```

### 8.2 GitLab CI

创建`.gitlab-ci.yml`文件：

```yaml
# .gitlab-ci.yml
# GitLab CI配置文件，用于自动化构建和部署NestJS应用
image: node:18-alpine

stages:
  - build
  - test
  - deploy

build:
  stage: build
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
  
test:
  stage: test
  script:
    - npm run test:cov
  
deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push $CI_REGISTRY_IMAGE:latest
    # 部署到服务器的脚本
  only:
    - main
```

## 9. 总结

本章节介绍了NestJS应用的多种部署方案，包括：

- Docker容器化部署，实现应用的跨平台运行
- Zeabur平台部署，简化部署流程，提供完整的服务生态
- 云平台部署，包括AWS和阿里云，提供强大的基础设施支持
- 使用PM2管理应用进程，提高应用的可靠性和性能
- 配置Nginx反向代理，提供负载均衡和SSL支持

同时，我们还介绍了部署最佳实践，包括环境隔离、自动化部署、监控和日志、安全配置、性能优化以及备份和恢复。

选择合适的部署方案需要考虑应用的规模、复杂度、团队技术栈和预算等因素。在实际项目中，建议结合CI/CD工具实现自动化部署，提高开发效率和部署质量。

## 10. 扩展阅读

- [Docker官方文档](https://docs.docker.com/)
- [Zeabur官方文档](https://docs.zeabur.com/)
- [NestJS部署文档](https://docs.nestjs.com/deployment) | [NestJS部署中文文档](https://nest.nodejs.cn/deployment)
- [PM2官方文档](https://pm2.keymetrics.io/)
- [Nginx官方文档](https://nginx.org/en/docs/)
- [GitHub Actions文档](https://docs.github.com/en/actions)
- [GitLab CI/CD文档](https://docs.gitlab.com/ee/ci/)
