# 邮件服务

邮件服务是Web应用中常见的扩展功能，用于发送验证码、通知、报表等。在本章节中，我们将实现完整的邮件服务功能，包括发送简单邮件、模板邮件、带附件的邮件等。

## 1. 安装依赖

首先，我们需要安装NestJS的邮件模块和相关依赖：

```bash
npm install @nestjs-modules/mailer nodemailer
npm install -D @types/nodemailer
# 如需使用Handlebars模板引擎
npm install hbs
# 如需使用Pug模板引擎  
npm install pug
# 如需使用EJS模板引擎
npm install ejs
```

- `@nestjs-modules/mailer`: NestJS的邮件模块，提供邮件发送功能
- `nodemailer`: Node.js的邮件发送库，用于底层邮件传输
- `@types/nodemailer`: TypeScript类型定义文件
- `hbs`/`pug`/`ejs`: 模板引擎，用于生成HTML邮件内容

## 2. 配置邮件服务

### 2.1 创建邮件配置文件

创建邮件配置文件，定义邮件服务器、用户名、密码等配置：

```typescript
// src/config/mail.config.ts
import { MailerOptions } from '@nestjs-modules/mailer';
import { HandlebarsAdapter } from '@nestjs-modules/mailer/dist/adapters/handlebars.adapter';
import { join } from 'path';

export const mailConfig: MailerOptions = {
  // 传输配置
  transport: {
    host: process.env.MAIL_HOST || 'smtp.qq.com',
    port: parseInt(process.env.MAIL_PORT || '465'),
    secure: true, // 使用SSL
    auth: {
      user: process.env.MAIL_USER || 'your-email@example.com',
      pass: process.env.MAIL_PASSWORD || 'your-email-password',
    },
  },
  // 默认发件人
  defaults: {
    from: process.env.MAIL_FROM || '"NestJS应用" <your-email@example.com>',
  },
  // 模板配置（使用Handlebars）
  template: {
    dir: join(__dirname, '../../templates/email'),
    adapter: new HandlebarsAdapter(),
    options: {
      strict: true,
    },
  },
};
```

### 2.2 注册邮件模块

在应用模块中注册邮件模块：

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { MailerModule } from '@nestjs-modules/mailer';
import { mailConfig } from './config/mail.config';

@Module({
  imports: [
    // 注册邮件模块
    MailerModule.forRoot(mailConfig),
    // 其他模块
  ],
})
export class AppModule {}
```

## 3. 创建邮件服务

创建邮件服务，处理邮件发送、模板渲染等业务逻辑：

```typescript
// src/services/mail.service.ts
import { Injectable, HttpException, HttpStatus } from '@nestjs/common';
import { MailerService } from '@nestjs-modules/mailer';

@Injectable()
export class MailService {
  constructor(private readonly mailerService: MailerService) {}
  
  /**
   * 发送简单邮件
   * @param to 收件人邮箱
   * @param subject 邮件主题
   * @param text 邮件文本内容
   * @param html 邮件HTML内容
   */
  async sendSimpleMail(
    to: string,
    subject: string,
    text: string,
    html?: string,
  ) {
    try {
      await this.mailerService.sendMail({
        to,
        subject,
        text,
        html,
      });
      return { message: '邮件发送成功' };
    } catch (error) {
      this.handleMailError(error);
    }
  }
  
  /**
   * 发送模板邮件
   * @param to 收件人邮箱
   * @param subject 邮件主题
   * @param template 模板名称
   * @param context 模板上下文数据
   */
  async sendTemplateMail(
    to: string,
    subject: string,
    template: string,
    context: any,
  ) {
    try {
      await this.mailerService.sendMail({
        to,
        subject,
        template,
        context,
      });
      return { message: '邮件发送成功' };
    } catch (error) {
      this.handleMailError(error);
    }
  }
  
  /**
   * 发送带附件的邮件
   * @param to 收件人邮箱
   * @param subject 邮件主题
   * @param text 邮件文本内容
   * @param attachments 附件列表
   */
  async sendMailWithAttachments(
    to: string,
    subject: string,
    text: string,
    attachments: any[],
  ) {
    try {
      await this.mailerService.sendMail({
        to,
        subject,
        text,
        attachments,
      });
      return { message: '邮件发送成功' };
    } catch (error) {
      this.handleMailError(error);
    }
  }
  
  /**
   * 发送验证码邮件
   * @param to 收件人邮箱
   * @param code 验证码
   * @param expiresIn 验证码有效期（分钟）
   */
  async sendVerificationCode(
    to: string,
    code: string,
    expiresIn: number = 10,
  ) {
    try {
      await this.mailerService.sendMail({
        to,
        subject: '验证码',
        template: 'verification-code',
        context: {
          code,
          expiresIn,
          appName: process.env.APP_NAME || 'NestJS应用',
        },
      });
      return { message: '验证码发送成功' };
    } catch (error) {
      this.handleMailError(error);
    }
  }
  
  /**
   * 发送密码重置邮件
   * @param to 收件人邮箱
   * @param resetUrl 密码重置URL
   * @param expiresIn 链接有效期（分钟）
   */
  async sendPasswordResetEmail(
    to: string,
    resetUrl: string,
    expiresIn: number = 30,
  ) {
    try {
      await this.mailerService.sendMail({
        to,
        subject: '密码重置',
        template: 'password-reset',
        context: {
          resetUrl,
          expiresIn,
          appName: process.env.APP_NAME || 'NestJS应用',
        },
      });
      return { message: '密码重置邮件发送成功' };
    } catch (error) {
      this.handleMailError(error);
    }
  }
  
  /**
   * 发送欢迎邮件
   * @param to 收件人邮箱
   * @param username 用户名
   */
  async sendWelcomeEmail(to: string, username: string) {
    try {
      await this.mailerService.sendMail({
        to,
        subject: '欢迎使用',
        template: 'welcome',
        context: {
          username,
          appName: process.env.APP_NAME || 'NestJS应用',
          supportEmail: process.env.SUPPORT_EMAIL || 'support@example.com',
        },
      });
      return { message: '欢迎邮件发送成功' };
    } catch (error) {
      this.handleMailError(error);
    }
  }
  
  /**
   * 处理邮件发送错误
   * @param error 错误对象
   */
  private handleMailError(error: any) {
    console.error('邮件发送失败:', error);
    throw new HttpException(
      `邮件发送失败: ${error.message || '未知错误'}`,
      HttpStatus.INTERNAL_SERVER_ERROR,
    );
  }
}
```

## 4. 创建邮件模板

创建邮件模板目录和模板文件，用于生成HTML邮件内容：

### 4.1 创建模板目录

```bash
mkdir -p src/templates/email
```

### 4.2 创建验证码模板

```handlebars
<!-- src/templates/email/verification-code.hbs -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{appName}} - 验证码</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-top: 50px;
    }
    .header {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    .header h1 {
      color: #333333;
      margin: 0;
    }
    .content {
      padding: 20px 0;
    }
    .content p {
      color: #666666;
      line-height: 1.6;
    }
    .code {
      font-size: 32px;
      font-weight: bold;
      color: #4285f4;
      text-align: center;
      margin: 20px 0;
      padding: 10px;
      background-color: #f0f8ff;
      border-radius: 4px;
    }
    .expire {
      text-align: center;
      color: #999999;
      font-size: 14px;
    }
    .footer {
      text-align: center;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
      color: #999999;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>{{appName}}</h1>
    </div>
    <div class="content">
      <p>您好，</p>
      <p>您正在尝试使用邮箱验证码进行操作，您的验证码是：</p>
      <div class="code">{{code}}</div>
      <p class="expire">验证码将在 {{expiresIn}} 分钟后过期，请尽快使用。</p>
      <p>如果您没有请求此验证码，请忽略此邮件。</p>
    </div>
    <div class="footer">
      <p>此邮件由 {{appName}} 自动发送，请勿回复。</p>
    </div>
  </div>
</body>
</html>
```

### 4.3 创建密码重置模板

```handlebars
<!-- src/templates/email/password-reset.hbs -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{appName}} - 密码重置</title>
  <style>
    /* 样式与验证码模板类似 */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>{{appName}}</h1>
    </div>
    <div class="content">
      <p>您好，</p>
      <p>您正在请求重置密码，请点击以下链接完成密码重置：</p>
      <p style="text-align: center; margin: 30px 0;">
        <a href="{{resetUrl}}" style="background-color: #4285f4; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; font-weight: bold;">
          重置密码
        </a>
      </p>
      <p class="expire">此链接将在 {{expiresIn}} 分钟后过期，请尽快使用。</p>
      <p>如果您没有请求重置密码，请忽略此邮件。</p>
    </div>
    <div class="footer">
      <p>此邮件由 {{appName}} 自动发送，请勿回复。</p>
    </div>
  </div>
</body>
</html>
```

### 4.4 创建欢迎邮件模板

```handlebars
<!-- src/templates/email/welcome.hbs -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{appName}} - 欢迎</title>
  <style>
    /* 样式与验证码模板类似 */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>{{appName}}</h1>
    </div>
    <div class="content">
      <p>亲爱的 {{username}}，</p>
      <p>欢迎加入 {{appName}}！</p>
      <p>我们很高兴您选择了我们的服务。您现在可以开始使用我们的所有功能了。</p>
      <p>如果您有任何问题或需要帮助，请随时联系我们的支持团队：{{supportEmail}}。</p>
      <p>祝您使用愉快！</p>
    </div>
    <div class="footer">
      <p>此邮件由 {{appName}} 自动发送，请勿回复。</p>
    </div>
  </div>
</body>
</html>
```

## 5. 创建邮件控制器

创建邮件控制器，处理邮件相关的HTTP请求：

```typescript
// src/controllers/mail.controller.ts
import { Controller, Post, Body, UseGuards } from '@nestjs/common';
import { MailService } from '../services/mail.service';
import { AuthGuard } from '../guards/auth.guard';
import { ApiTags, ApiOperation, ApiBody, ApiResponse } from '@nestjs/swagger';

@ApiTags('邮件服务')
@UseGuards(AuthGuard)
@Controller('mail')
export class MailController {
  constructor(private readonly mailService: MailService) {}
  
  /**
   * 发送简单邮件
   * @param body 邮件内容
   */
  @Post('simple')
  @ApiOperation({ summary: '发送简单邮件' })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        to: { type: 'string', example: 'recipient@example.com' },
        subject: { type: 'string', example: '测试邮件' },
        text: { type: 'string', example: '这是一封测试邮件' },
        html: { type: 'string', example: '<h1>测试邮件</h1><p>这是一封测试邮件</p>' },
      },
      required: ['to', 'subject', 'text'],
    },
  })
  @ApiResponse({ status: 200, description: '邮件发送成功' })
  async sendSimpleMail(@Body() body: {
    to: string;
    subject: string;
    text: string;
    html?: string;
  }) {
    return await this.mailService.sendSimpleMail(
      body.to,
      body.subject,
      body.text,
      body.html,
    );
  }
  
  /**
   * 发送验证码邮件
   * @param body 邮件内容
   */
  @Post('verification-code')
  @ApiOperation({ summary: '发送验证码邮件' })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        to: { type: 'string', example: 'recipient@example.com' },
        code: { type: 'string', example: '123456' },
        expiresIn: { type: 'number', example: 10 },
      },
      required: ['to', 'code'],
    },
  })
  @ApiResponse({ status: 200, description: '验证码发送成功' })
  async sendVerificationCode(@Body() body: {
    to: string;
    code: string;
    expiresIn?: number;
  }) {
    return await this.mailService.sendVerificationCode(
      body.to,
      body.code,
      body.expiresIn,
    );
  }
  
  /**
   * 发送密码重置邮件
   * @param body 邮件内容
   */
  @Post('password-reset')
  @ApiOperation({ summary: '发送密码重置邮件' })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        to: { type: 'string', example: 'recipient@example.com' },
        resetUrl: { type: 'string', example: 'https://example.com/reset-password?token=xxx' },
        expiresIn: { type: 'number', example: 30 },
      },
      required: ['to', 'resetUrl'],
    },
  })
  @ApiResponse({ status: 200, description: '密码重置邮件发送成功' })
  async sendPasswordResetEmail(@Body() body: {
    to: string;
    resetUrl: string;
    expiresIn?: number;
  }) {
    return await this.mailService.sendPasswordResetEmail(
      body.to,
      body.resetUrl,
      body.expiresIn,
    );
  }
  
  /**
   * 发送欢迎邮件
   * @param body 邮件内容
   */
  @Post('welcome')
  @ApiOperation({ summary: '发送欢迎邮件' })
  @ApiBody({
    schema: {
      type: 'object',
      properties: {
        to: { type: 'string', example: 'recipient@example.com' },
        username: { type: 'string', example: 'testuser' },
      },
      required: ['to', 'username'],
    },
  })
  @ApiResponse({ status: 200, description: '欢迎邮件发送成功' })
  async sendWelcomeEmail(@Body() body: {
    to: string;
    username: string;
  }) {
    return await this.mailService.sendWelcomeEmail(body.to, body.username);
  }
}
```

## 6. 创建邮件模块

将邮件服务和控制器组织到一个模块中：

```typescript
// src/modules/mail/mail.module.ts
import { Module } from '@nestjs/common';
import { MailController } from '../../controllers/mail.controller';
import { MailService } from '../../services/mail.service';

@Module({
  controllers: [MailController],
  providers: [MailService],
  exports: [MailService],
})
export class MailModule {}
```

然后在主模块中导入MailModule：

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { MailModule } from './modules/mail/mail.module';

@Module({
  imports: [
    // 其他模块
    MailModule,
  ],
})
export class AppModule {}
```

## 7. 实现邮件队列

对于大量邮件发送或需要异步处理的情况，我们可以使用消息队列来处理邮件发送：

### 7.1 安装队列依赖

```bash
npm install @nestjs/bull bull
npm install -D @types/bull
```

### 7.2 配置队列

```typescript
// src/config/bull.config.ts
import { BullModuleOptions } from '@nestjs/bull';

export const bullConfig: BullModuleOptions = {
  redis: {
    host: process.env.REDIS_HOST || 'localhost',
    port: parseInt(process.env.REDIS_PORT || '6379'),
    password: process.env.REDIS_PASSWORD,
  },
};
```

### 7.3 创建邮件队列处理器

```typescript
// src/processors/mail.processor.ts
import { Process, Processor } from '@nestjs/bull';
import { Job } from 'bull';
import { MailService } from '../services/mail.service';

@Processor('mail')
export class MailProcessor {
  constructor(private readonly mailService: MailService) {}
  
  // 处理发送邮件任务
  @Process('sendMail')
  async handleSendMail(job: Job) {
    const { data } = job;
    
    try {
      switch (data.type) {
        case 'simple':
          return await this.mailService.sendSimpleMail(
            data.to,
            data.subject,
            data.text,
            data.html,
          );
        case 'verificationCode':
          return await this.mailService.sendVerificationCode(
            data.to,
            data.code,
            data.expiresIn,
          );
        case 'passwordReset':
          return await this.mailService.sendPasswordResetEmail(
            data.to,
            data.resetUrl,
            data.expiresIn,
          );
        case 'welcome':
          return await this.mailService.sendWelcomeEmail(
            data.to,
            data.username,
          );
        default:
          throw new Error(`未知的邮件类型: ${data.type}`);
      }
    } catch (error) {
      console.error(`处理邮件任务失败: ${error.message}`, job.data);
      throw error;
    }
  }
}
```

### 7.4 创建邮件队列服务

```typescript
// src/services/mail-queue.service.ts
import { Injectable } from '@nestjs/common';
import { Queue } from 'bull';
import { InjectQueue } from '@nestjs/bull';

@Injectable()
export class MailQueueService {
  constructor(@InjectQueue('mail') private readonly mailQueue: Queue) {}
  
  /**
   * 发送简单邮件（队列）
   */
  async sendSimpleMail(to: string, subject: string, text: string, html?: string) {
    return await this.mailQueue.add('sendMail', {
      type: 'simple',
      to,
      subject,
      text,
      html,
    });
  }
  
  /**
   * 发送验证码邮件（队列）
   */
  async sendVerificationCode(to: string, code: string, expiresIn?: number) {
    return await this.mailQueue.add('sendMail', {
      type: 'verificationCode',
      to,
      code,
      expiresIn,
    });
  }
  
  /**
   * 发送密码重置邮件（队列）
   */
  async sendPasswordResetEmail(to: string, resetUrl: string, expiresIn?: number) {
    return await this.mailQueue.add('sendMail', {
      type: 'passwordReset',
      to,
      resetUrl,
      expiresIn,
    });
  }
  
  /**
   * 发送欢迎邮件（队列）
   */
  async sendWelcomeEmail(to: string, username: string) {
    return await this.mailQueue.add('sendMail', {
      type: 'welcome',
      to,
      username,
    });
  }
}
```

## 8. 邮件服务测试

使用Jest测试邮件服务：

```typescript
// test/mail/mail.service.spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { MailService } from '../../src/services/mail.service';
import { MailerService } from '@nestjs-modules/mailer';

describe('MailService', () => {
  let mailService: MailService;
  let mailerService: jest.Mocked<MailerService>;
  
  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        MailService,
        {
          provide: MailerService,
          useValue: {
            sendMail: jest.fn(),
          },
        },
      ],
    }).compile();
    
    mailService = module.get<MailService>(MailService);
    mailerService = module.get(MailerService) as jest.Mocked<MailerService>;
  });
  
  // 测试发送简单邮件
  it('should send simple mail', async () => {
    mailerService.sendMail.mockResolvedValue(undefined);
    
    const result = await mailService.sendSimpleMail(
      'test@example.com',
      'Test Subject',
      'Test Text',
    );
    
    expect(mailerService.sendMail).toHaveBeenCalled();
    expect(result).toEqual({ message: '邮件发送成功' });
  });
  
  // 测试发送验证码邮件
  it('should send verification code', async () => {
    mailerService.sendMail.mockResolvedValue(undefined);
    
    const result = await mailService.sendVerificationCode(
      'test@example.com',
      '123456',
    );
    
    expect(mailerService.sendMail).toHaveBeenCalled();
    expect(result).toEqual({ message: '验证码发送成功' });
  });
  
  // 测试发送密码重置邮件
  it('should send password reset email', async () => {
    mailerService.sendMail.mockResolvedValue(undefined);
    
    const result = await mailService.sendPasswordResetEmail(
      'test@example.com',
      'https://example.com/reset',
    );
    
    expect(mailerService.sendMail).toHaveBeenCalled();
    expect(result).toEqual({ message: '密码重置邮件发送成功' });
  });
});
```

## 9. 邮件服务最佳实践

1. **使用环境变量**：将邮件配置（如用户名、密码、服务器地址）存储在环境变量中，避免硬编码
2. **使用模板引擎**：使用模板引擎生成HTML邮件内容，提高邮件的可读性和美观度
3. **实现异步发送**：对于大量邮件发送或需要异步处理的情况，使用消息队列（如Bull）处理邮件发送
4. **添加重试机制**：实现邮件发送失败后的重试机制，提高邮件发送的可靠性
5. **监控邮件发送**：记录邮件发送日志，监控邮件发送成功率和失败原因
6. **优化邮件内容**：
   - 保持邮件内容简洁明了
   - 使用响应式设计，确保在移动设备上正常显示
   - 添加退订链接，遵守邮件发送法规
7. **保护敏感信息**：不要在邮件中包含敏感信息，如密码、信用卡号等
8. **测试邮件发送**：在开发环境中测试邮件发送功能，确保邮件内容和格式正确
9. **使用信誉良好的邮件服务器**：使用信誉良好的邮件服务器，避免邮件被标记为垃圾邮件
10. **遵守邮件发送法规**：遵守相关邮件发送法规，如CAN-SPAM Act、GDPR等

## 10. 总结

本章节我们实现了完整的邮件服务功能，包括：

1. 邮件服务配置和依赖安装
2. 简单邮件、模板邮件、带附件邮件的发送
3. 邮件模板的创建和使用
4. 验证码邮件、密码重置邮件、欢迎邮件等常见邮件类型的实现
5. 邮件队列的实现，用于异步处理邮件发送
6. 邮件服务测试
7. 邮件服务最佳实践

邮件服务是Web应用中重要的扩展功能，通过本章节的学习，我们掌握了NestJS中邮件服务的完整实现方案，可以根据实际业务需求进行扩展和优化。